<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMDConnect Platform - Care Provider Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="Assets/mmdconnect.png" alt="MMDConnect" class="logo">
                <span class="logo-text">MMDConnect</span>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item active">
                        <img src="Assets/√∂versikt.png" alt="√ñversikt" class="nav-icon">
                        <span class="nav-text">√ñversikt</span>
                    </li>
                    <li class="nav-item journaldata">
                        <img src="Assets/journaldata.png" alt="Journaldata" class="nav-icon">
                        <span class="nav-text">Journaldata</span>
                    </li>
                    <li class="nav-item">
                        <a href="gpt-chat.html" class="nav-link">
                            <img src="Assets/halsa-gpt.png" alt="H√§lsa+ GPT" class="nav-icon">
                            <span class="nav-text">H√§lsa+ GPT</span>
                        </a>
                    </li>
                </ul>
                
                <ul class="nav-list-bottom">
                    <li class="nav-item">
                        <img src="Assets/hj√§lp.png" alt="Hj√§lp" class="nav-icon">
                        <span class="nav-text">Hj√§lp</span>
                    </li>
                    <li class="nav-item">
                        <img src="Assets/inst√§llningar.png" alt="Inst√§llningar" class="nav-icon">
                        <span class="nav-text">Inst√§llningar</span>
                    </li>
                    <li class="nav-item" onclick="showLogoutOverlay()">
                        <img src="Assets/avsluta.png" alt="Avsluta" class="nav-icon">
                        <span class="nav-text">Avsluta</span>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="patient-info">
                    <h1>Patient: Anders Boman</h1>
                    <p class="patient-id">19650314-xxxx</p>
                    <p class="patient-date">2024-09-09</p>
                </div>
                <div class="user-info">
                    <span class="user-name">Dr. Anna Andersson</span>
                    <div class="user-avatar">AA</div>
                </div>
            </div>

            <div class="overview-grid">
                <!-- Main Layout: Journal (50%) | Health Data + Upload (50%) -->
                <div class="main-layout">
                    <!-- Journal Card - 50% Width -->
                    <div class="journal-card card-animate">
                        <h2 class="card-title">Journalanteckningar</h2>
                        <div class="journal-content">
                            <!-- PDF entries will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Right Column - 50% Width with stacked cards -->
                    <div class="right-column">
                    <div class="health-card card-animate">
                        <h2 class="card-title">H√§lsodata</h2>
                        <div class="organ-list">
                            <a href="heart.html" class="organ-item-link">
                                <div class="organ-item">
                                    <div class="organ-header">
                                        <div class="icon-container">
                                            <img src="Assets/heart.png" alt="Heart" class="organ-icon">
                                            <div class="status-indicator good"></div>
                                        </div>
                                        <h3 class="organ-name">Hj√§rta</h3>
                                        <span class="data-count">8 datapunkter tillg√§ngliga</span>
                                        <div class="chevron">‚Ä∫</div>
                                    </div>
                                </div>
                            </a>
                            </div>
                        </div>

                        <!-- File Upload Section -->
                        <div class="upload-card card-animate">
                            <h2 class="card-title">Mottagna filer</h2>
                            <div class="file-categories" id="file-categories">
                                <!-- File categories will be populated here -->
                            </div>
                            <!-- Debug buttons -->
                            <div style="margin-top: 16px; padding: 16px; background: #f3f4f6; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #374151;">Debug Tools</h4>
                                <button onclick="debugFileTransfer()" style="margin-right: 8px; padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Check Files</button>
                                <button onclick="debugMobileState()" style="margin-right: 8px; padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Debug Mobile</button>
                                <button onclick="clearAllFiles()" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Clear Files</button>
                                <div id="debug-info" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Logout Overlay -->
    <div id="logout-overlay" class="logout-overlay" style="display: none;">
        <div class="logout-modal">
            <div class="logout-modal-content">
                <div class="logout-info-card">
                    <h3 style="margin: 0 0 8px 0; color: #1D212B; font-size: 20px;">Logga ut</h3>
                    <p style="margin: 0; color: #666; font-size: 16px;">√Ñr du s√§ker p√• att du vill logga ut fr√•n MMDConnect?</p>
                </div>
            </div>
            <div class="logout-modal-actions">
                <button onclick="hideLogoutOverlay()" class="logout-btn-cancel">Avbryt</button>
                <button onclick="confirmLogout()" class="logout-btn-confirm">Logga ut</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let uploadedFiles = [];
        let currentTransferId = null;
        let eventSource = null;

        function logout() {
            showLogoutOverlay();
        }

        // Trigger dashboard page animations
        document.addEventListener('DOMContentLoaded', function() {
            // Animate cards with staggered timing
            const cards = document.querySelectorAll('.card-animate');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('loaded');
                }, 100 + (index * 100));
            });
            
            // Initialize file upload functionality
            initializeFileUpload();
            
            // Add escape key listener for logout overlay
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    hideLogoutOverlay();
                }
            });
        });

        async function initializeFileUpload() {
            // Check if there's a transfer ID in localStorage from login page
            const savedTransferId = localStorage.getItem('currentTransferId');
            console.log('Checking localStorage for transfer ID:', savedTransferId);
            
            if (savedTransferId) {
                currentTransferId = savedTransferId;
                console.log('Found transfer ID:', currentTransferId);
                
                // Show loading state
                console.log('Loading files from mobile app...');
                
                // Always load fresh files from mobile app when coming from redirect
                await loadUploadedFiles();
                startFileEventStream();
                
            } else {
                console.log('No transfer ID found in localStorage');
                // Load any previously saved files from localStorage as fallback
                loadFilesFromStorage();
                console.log('Please use the QR code from the login page to upload files');
            }
        }

        async function loadUploadedFiles() {
            if (!currentTransferId) {
                console.log('No transfer ID available for loading files');
                return;
            }

            console.log('Loading files for transfer ID:', currentTransferId);
            try {
                // Load files from API endpoint (most reliable for cross-context communication)
                const url = `/api/files?transferId=${currentTransferId}`;
                console.log('Fetching files from API:', url);
                
                const response = await fetch(url);
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded files data from API:', data);
                    uploadedFiles = data.files || [];
                    console.log('Number of files loaded from API:', uploadedFiles.length);
                    
                    saveFilesToStorage(); // Save to localStorage
                    updateFileDisplay();
                    
                    // Show notification if files were loaded
                    if (uploadedFiles.length > 0) {
                        showFileNotification({ size: 0 }); // Special notification for mobile files
                    }
                    
                    // Load imported journal notes if any PDF files exist
                    await loadImportedJournalNotes();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load files from API, status:', response.status);
                    console.error('Error response:', errorText);
                    
                    // Fallback to localStorage if API fails
                    console.log('API failed, trying localStorage fallback...');
                    const storageKey = `mmd_files_${currentTransferId}`;
                    const filesData = localStorage.getItem(storageKey);
                    
                    if (filesData) {
                        const files = JSON.parse(filesData);
                        console.log('Loaded files from localStorage fallback:', files);
                        uploadedFiles = files || [];
                        console.log('Number of files loaded from localStorage:', uploadedFiles.length);
                        
                        saveFilesToStorage(); // Save to localStorage
                        updateFileDisplay();
                        
                        // Show notification if files were loaded
                        if (uploadedFiles.length > 0) {
                            showFileNotification({ size: 0 }); // Special notification for mobile files
                        }
                        
                        // Load imported journal notes if any PDF files exist
                        await loadImportedJournalNotes();
                    }
                }
            } catch (error) {
                console.error('Failed to load uploaded files from mobile app:', error);
            }
        }

        async function loadImportedJournalNotes() {
            if (!currentTransferId) return;
            
            // Find PDF files in the uploaded files
            const pdfFiles = uploadedFiles.filter(file => 
                file.mimetype === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
            
            const journalContent = document.querySelector('.journal-content');
            
            if (pdfFiles.length > 0) {
                // Clear existing PDF cards and empty state
                journalContent.innerHTML = '';
                
                // Create a card for each PDF file
                for (const pdfFile of pdfFiles) {
                    try {
                        // Load PDF content from mobile app
                        const response = await fetch(`/api/pdf-content?transferId=${currentTransferId}&filename=${encodeURIComponent(pdfFile.name)}`);
                        
                        if (response.ok) {
                            const parsedData = await response.json();
                            const pdfCard = createPDFJournalCard(pdfFile, parsedData);
                            journalContent.appendChild(pdfCard);
                        } else {
                            console.error(`Failed to load PDF content for ${pdfFile.name}, status:`, response.status);
                            // Create a basic card even if content loading fails
                            const basicCard = createBasicPDFCard(pdfFile);
                            journalContent.appendChild(basicCard);
                        }
                    } catch (error) {
                        console.error(`Failed to load PDF content for ${pdfFile.name}:`, error);
                        // Create a basic card even if content loading fails
                        const basicCard = createBasicPDFCard(pdfFile);
                        journalContent.appendChild(basicCard);
                    }
                }
            } else {
                showEmptyJournalState();
            }
        }

        function formatStructuredContent(content) {
            // If content is a string (old format), return it as is
            if (typeof content === 'string') {
                return `<h4>Importerad Journalanteckning</h4><p>${content}</p>`;
            }
            
            // If content is structured (new format), show full content as one block
            if (typeof content === 'object' && content !== null) {
                let html = '<h4>Importerad Journalanteckning</h4>';
                
                // Combine all content into one readable text
                let fullContent = '';
                
                // Define section order and Swedish labels
                const sectionOrder = [
                    { key: 'anamnes', label: 'Anamnes' },
                    { key: 'status', label: 'Status' },
                    { key: 'undersokningar', label: 'Unders√∂kningar' },
                    { key: 'bedomning', label: 'Bed√∂mning' },
                    { key: 'rekommendationer', label: 'Rekommendationer' },
                    { key: 'medicin', label: 'Medicin/Behandling' }
                ];
                
                // Add structured sections to full content
                sectionOrder.forEach(section => {
                    if (content[section.key]) {
                        fullContent += `<strong>${section.label}:</strong> ${content[section.key]}\n\n`;
                    }
                });
                
                // Add other content if any
                if (content.other && content.other.length > 0) {
                    fullContent += `<strong>√ñvrig information:</strong> ${content.other.join(' ')}\n\n`;
                }
                
                // Display as single paragraph with line breaks
                html += `<div class="journal-full-content"><p>${fullContent.replace(/\n\n/g, '</p><p>')}</p></div>`;
                
                return html;
            }
            
            // Fallback
            return `<h4>Importerad Journalanteckning</h4><p>Inneh√•llet kunde inte formateras korrekt.</p>`;
        }

        function createPDFJournalCard(pdfFile, parsedData) {
            const card = document.createElement('div');
            card.className = 'journal-entry pdf-journal-entry';
            card.onclick = () => toggleJournalEntry(card);
            
            // Use the parsed data from the server
            const title = parsedData.title || generatePDFTitle(parsedData.content, pdfFile.name);
            const doctor = parsedData.doctor || 'Importerad fr√•n PDF';
            const date = parsedData.date || new Date(pdfFile.uploadedAt || Date.now()).toLocaleDateString('sv-SE');
            const summary = parsedData.summary || generatePDFSummary(parsedData.content);
            
            card.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${title}</h3>
                        <p class="journal-doctor">${doctor}</p>
                        <p class="journal-date">${date}</p>
                        <p class="journal-summary">${summary}</p>
                    </div>
                    <div class="chevron">‚Ä∫</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="H√§lsa+GPT" style="width: 16px; height: 16px;">
                            Summera med H√§lsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        ${formatStructuredContent(parsedData.content)}
                    </div>
                </div>
            `;
            
            return card;
        }

        function createBasicPDFCard(pdfFile) {
            const card = document.createElement('div');
            card.className = 'journal-entry pdf-journal-entry';
            card.onclick = () => toggleJournalEntry(card);
            
            const uploadDate = new Date(pdfFile.uploadedAt || Date.now()).toLocaleDateString('sv-SE');
            
            card.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${pdfFile.name}</h3>
                        <p class="journal-doctor">Importerad fr√•n PDF</p>
                        <p class="journal-date">${uploadDate}</p>
                        <p class="journal-summary">PDF-fil importerad fr√•n mobilen. Inneh√•ll kunde inte analyseras.</p>
                    </div>
                    <div class="chevron">‚Ä∫</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="H√§lsa+GPT" style="width: 16px; height: 16px;">
                            Summera med H√§lsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        <h4>PDF-fil:</h4>
                        <p>Filnamn: ${pdfFile.name}</p>
                        <p>Storlek: ${Math.round(pdfFile.size / 1024)} KB</p>
                        <p>Typ: ${pdfFile.mimetype}</p>
                    </div>
                </div>
            `;
            
            return card;
        }

        function generatePDFTitle(content, filename) {
            // Try to extract a meaningful title from the content
            if (typeof content === 'object' && content.anamnes) {
                // Look for common medical terms in anamnes
                const anamnes = content.anamnes.toLowerCase();
                if (anamnes.includes('kontroll') || anamnes.includes('uppf√∂ljning')) {
                    return 'Uppf√∂ljning - ' + extractPatientInfo(content);
                } else if (anamnes.includes('akut') || anamnes.includes('besv√§r')) {
                    return 'Akutbes√∂k - ' + extractPatientInfo(content);
                } else if (anamnes.includes('operation') || anamnes.includes('kirurgi')) {
                    return 'Operation - ' + extractPatientInfo(content);
                }
            }
            
            // Fallback to filename or generic title
            const cleanFilename = filename.replace(/\.pdf$/i, '').replace(/[_-]/g, ' ');
            return cleanFilename || 'Importerad Journalanteckning';
        }

        function extractPatientInfo(content) {
            if (typeof content === 'object' && content.anamnes) {
                // Try to extract age, gender, or condition from anamnes
                const anamnes = content.anamnes;
                const ageMatch = anamnes.match(/(\d+)\s*√•r/);
                const genderMatch = anamnes.match(/(man|kvinna|patient)/i);
                
                if (ageMatch && genderMatch) {
                    return `${genderMatch[1]} ${ageMatch[1]} √•r`;
                } else if (ageMatch) {
                    return `${ageMatch[1]} √•r`;
                }
            }
            return 'Patient';
        }

        function generatePDFSummary(content) {
            if (typeof content === 'object') {
                if (content.bed√∂mning) {
                    return content.bed√∂mning.substring(0, 80) + (content.bed√∂mning.length > 80 ? '...' : '');
                } else if (content.status) {
                    return content.status.substring(0, 80) + (content.status.length > 80 ? '...' : '');
                } else if (content.anamnes) {
                    return content.anamnes.substring(0, 80) + (content.anamnes.length > 80 ? '...' : '');
                }
            } else if (typeof content === 'string') {
                return content.substring(0, 80) + (content.length > 80 ? '...' : '');
            }
            return 'Importerad journalanteckning fr√•n PDF-fil.';
        }

        function replaceJournalEntriesWithImported(importedContent) {
            const journalContent = document.querySelector('.journal-content');
            if (!journalContent) return;
            
            // Create a new journal entry based on imported content
            const newEntry = document.createElement('div');
            newEntry.className = 'journal-entry';
            newEntry.onclick = function() { toggleJournalEntry(this); };
            
            newEntry.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${importedContent.title}</h3>
                        <p class="journal-doctor">${importedContent.doctor}</p>
                        <p class="journal-date">${importedContent.date}</p>
                        <p class="journal-summary">${importedContent.summary}</p>
                    </div>
                    <div class="chevron">‚Ä∫</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="H√§lsa+GPT" style="width: 16px; height: 16px;">
                            Summera med H√§lsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        ${formatStructuredContent(importedContent.content)}
                    </div>
                </div>
            `;
            
            // Replace all existing journal entries with the imported one
            journalContent.innerHTML = '';
            journalContent.appendChild(newEntry);
        }

        function startFileEventStream() {
            if (!currentTransferId) return;

            // Note: EventSource is not available for cross-origin requests in serverless
            // We'll rely on the polling mechanism from the login page instead
            console.log('EventSource not available for cross-origin serverless apps - using polling instead');
            
            // Start polling for new files every 10 seconds
            const pollForFiles = async () => {
                try {
                    const response = await fetch(`/api/files?transferId=${currentTransferId}`);
                    if (response.ok) {
                        const data = await response.json();
                        const newFiles = data.files || [];
                        
                        // Check if we have new files
                        if (newFiles.length > uploadedFiles.length) {
                            console.log('New files detected, refreshing display');
                            uploadedFiles = newFiles;
                            saveFilesToStorage();
                            updateFileDisplay();
                            await loadImportedJournalNotes();
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll for new files:', error);
                }
            };
            
            // Poll immediately and then every 10 seconds
            pollForFiles();
            setInterval(pollForFiles, 10000);
        }

        function updateFileDisplay() {
            const categoriesContainer = document.getElementById('file-categories');
            console.log('=== UPDATE FILE DISPLAY ===');
            console.log('Updating file display with', uploadedFiles.length, 'files');
            console.log('Files array:', uploadedFiles);

            if (uploadedFiles.length === 0) {
                console.log('No files to display, showing empty message');
                categoriesContainer.innerHTML = '<p class="empty-category">Inga filer att visa</p>';
                return;
            }

            // Categorize files by type
            const categorized = categorizeFilesByType(uploadedFiles);
            console.log('Categorized files by type:', categorized);
            
            // Render categories
            categoriesContainer.innerHTML = '';
            
            const categoryConfigs = [
                { key: 'excel', name: 'Provsvar', icon: '' },
                { key: 'pdf', name: 'Journalanteckningar', icon: '' }
            ];

            let totalDisplayed = 0;
            categoryConfigs.forEach(config => {
                const files = categorized[config.key] || [];
                console.log(`Category ${config.name}: ${files.length} files`);
                if (files.length > 0) {
                    const categoryDiv = createCategoryElement(config, files);
                    categoriesContainer.appendChild(categoryDiv);
                    totalDisplayed += files.length;
                }
            });
            
            console.log(`Total files displayed: ${totalDisplayed}`);
            console.log('=== END UPDATE FILE DISPLAY ===');
        }

        function createCategoryElement(config, files) {
            const div = document.createElement('div');
            div.className = 'file-category-expandable';
            
            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <div class="category-title-row">
                    <h3 class="category-title">${config.name}</h3>
                    <span class="file-count">${files.length}</span>
                </div>
                <div class="chevron">‚Ä∫</div>
            `;
            
            const fileList = document.createElement('div');
            fileList.className = 'file-list-vertical';
            fileList.style.display = 'none'; // Initially hidden
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item-vertical';
                
                const fileType = file.mimetype === 'application/pdf' ? 'pdf' : 'excel';
                const fileDate = new Date(file.uploadedAt).toLocaleDateString('sv-SE');
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name file-type-${fileType}">${file.name}</div>
                        <div class="file-details">
                            <span class="file-date">${fileDate}</span>
                            <span class="file-size">${Math.round(file.size/1024)} KB</span>
                        </div>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // Add click handler for expand/collapse
            header.addEventListener('click', () => {
                const isExpanded = fileList.style.display !== 'none';
                fileList.style.display = isExpanded ? 'none' : 'flex';
                div.classList.toggle('expanded', !isExpanded);
            });
            
            div.appendChild(header);
            div.appendChild(fileList);
            
            return div;
        }

        function categorizeFilesByType(files) {
            const categories = {
                excel: [],
                pdf: []
            };

            files.forEach(file => {
                if (file.mimetype === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
                    file.name.toLowerCase().endsWith('.xlsx')) {
                    categories.excel.push(file);
                } else if (file.mimetype === 'application/pdf' || 
                           file.name.toLowerCase().endsWith('.pdf')) {
                    categories.pdf.push(file);
                } else {
                    // Default to PDF for unknown types
                    categories.pdf.push(file);
                }
            });

            return categories;
        }

        function categorizeFiles(files) {
            const categories = {
                heart: [],
                bp: [],
                glucose: [],
                activity: [],
                notes: [],
                other: []
            };

            files.forEach(file => {
                const name = file.name.toLowerCase();
                let categorized = false;

                // Heart-related files
                if (/\b(ecg|ekg|heart|cardio|pulse|hj√§rta|hj√§rt)\b/.test(name)) {
                    categories.heart.push(file);
                    categorized = true;
                }
                // Blood pressure files
                else if (/\b(bp|blood[- ]?pressure|systolic|diastolic|blodtryck)\b/.test(name)) {
                    categories.bp.push(file);
                    categorized = true;
                }
                // Glucose/blood sugar files
                else if (/\b(glucose|bg|cgm|hba1c|a1c|glukos|blodsocker)\b/.test(name)) {
                    categories.glucose.push(file);
                    categorized = true;
                }
                // Activity/fitness files
                else if (/\b(steps|activity|workout|hrv|vo2|fitness|aktivitet|tr√§ning)\b/.test(name)) {
                    categories.activity.push(file);
                    categorized = true;
                }
                // Notes/journal files
                else if (/\b(note|journal|anteckning|anteckningar|journalanteckningar|notat)\b/.test(name)) {
                    categories.notes.push(file);
                    categorized = true;
                }

                if (!categorized) {
                    categories.other.push(file);
                }
            });

            return categories;
        }

        function showFileNotification(file) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #059669;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 350px;
                border-left: 4px solid #047857;
                animation: slideIn 0.3s ease-out;
            `;
            
            if (file.size === 0) {
                // Special case for welcome message
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">üì±</span>
                        <div>
                            <div style="font-weight: 600;">Mobilfiler laddade!</div>
                            <div style="font-size: 12px; opacity: 0.9;">Filer fr√•n din mobil visas nedan</div>
                        </div>
                    </div>
                `;
            } else {
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">üìÑ</span>
                        <div>
                            <div style="font-weight: 600;">Ny fil mottagen</div>
                            <div style="font-size: 12px; opacity: 0.9;">${file.name}</div>
                        </div>
                    </div>
                `;
            }
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                    style.remove();
                }, 300);
            }, 4000);
        }

        async function refreshUploadedFiles() {
            await loadUploadedFiles();
        }

        function saveFilesToStorage() {
            // Save uploaded files to localStorage so they persist
            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            console.log('Saved', uploadedFiles.length, 'files to localStorage');
        }

        function loadFilesFromStorage() {
            // Load previously saved files from localStorage
            const savedFiles = localStorage.getItem('uploadedFiles');
            if (savedFiles) {
                uploadedFiles = JSON.parse(savedFiles);
                console.log('Loaded', uploadedFiles.length, 'files from localStorage');
                updateFileDisplay();
                
                // Also load journal notes if there are PDF files
                const pdfFiles = uploadedFiles.filter(file => 
                    file.mimetype === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                );
                if (pdfFiles.length > 0) {
                    loadImportedJournalNotes();
                } else {
                    showEmptyJournalState();
                }
            } else {
                showEmptyJournalState();
            }
        }

        function showEmptyJournalState() {
            const journalContent = document.querySelector('.journal-content');
            if (journalContent && journalContent.children.length === 0) {
                journalContent.innerHTML = `
                    <div class="empty-journal-state">
                        <p>Inga journalanteckningar tillg√§ngliga √§nnu.</p>
                        <p class="empty-hint">Ladda upp PDF-filer fr√•n din mobil f√∂r att se importerade journalanteckningar h√§r.</p>
                    </div>
                `;
            }
        }

        function clearAllFiles() {
            // Clear all saved files (for logout or manual clear)
            uploadedFiles = [];
            localStorage.removeItem('uploadedFiles');
            updateFileDisplay();
            console.log('Cleared all files');
        }

        async function debugFileTransfer() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'Checking file transfer status...';
            
            try {
                console.log('=== DEBUG FILE TRANSFER ===');
                console.log('Current transfer ID:', currentTransferId);
                console.log('Local uploaded files:', uploadedFiles);
                
                if (!currentTransferId) {
                    debugInfo.innerHTML = '‚ùå No transfer ID found';
                    return;
                }
                
                // Check mobile app for files
                const url = `/api/files?transferId=${currentTransferId}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Mobile app response:', data);
                    
                    debugInfo.innerHTML = `
                        ‚úÖ Transfer ID: ${currentTransferId}<br>
                        üìÅ Files on mobile: ${data.files.length}<br>
                        üìÅ Files locally: ${uploadedFiles.length}<br>
                        üîÑ Status: ${data.status}
                    `;
                    
                    if (data.files.length > 0) {
                        debugInfo.innerHTML += `<br>üìã Files: ${data.files.map(f => f.name).join(', ')}`;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    debugInfo.innerHTML = `‚ùå Error: ${response.status} - ${errorText}`;
                }
            } catch (error) {
                console.error('Debug error:', error);
                debugInfo.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function debugMobileState() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'Checking mobile app global state...';
            
            try {
                console.log('=== DEBUG MOBILE STATE ===');
                
                // Check mobile app's global state
                const url = `/api/debug?transferId=${currentTransferId}`;
                console.log('Fetching debug info from:', url);
                
                const response = await fetch(url);
                console.log('Debug response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Mobile app debug response:', data);
                    
                    let debugHtml = `
                        üîç Mobile App Debug Info:<br>
                        üìä Global State Size: ${data.globalStateSize}<br>
                        üìÅ Storage file exists: ${data.storageFileExists || 'N/A'}<br>
                        üß† Memory fallback size: ${data.memoryFallbackSize || 0}<br>
                        ‚è∞ Timestamp: ${data.timestamp || 'N/A'}<br>
                    `;
                    
                    if (data.storageFileContent) {
                        debugHtml += `üìÑ Storage content: <pre style="font-size: 10px; max-height: 100px; overflow: auto; background: #f5f5f5; padding: 5px;">${data.storageFileContent}</pre>`;
                    }
                    
                    if (data.memoryFallback && Object.keys(data.memoryFallback).length > 0) {
                        debugHtml += `üß† Memory fallback: <pre style="font-size: 10px; max-height: 100px; overflow: auto; background: #e8f4fd; padding: 5px;">${JSON.stringify(data.memoryFallback, null, 2)}</pre>`;
                    }
                    
                    if (data.allTransfers && data.allTransfers.length > 0) {
                        debugHtml += `üÜî All Transfer IDs: ${data.allTransfers.map(([id, transfer]) => id).join(', ')}<br>`;
                        debugHtml += `üìÅ Current Transfer: <pre style="font-size: 10px; max-height: 100px; overflow: auto; background: #f5f5f5; padding: 5px;">${data.transfer ? JSON.stringify(data.transfer, null, 2) : 'Not found'}</pre>`;
                    } else {
                        debugHtml += `üìã No transfers found`;
                    }
                    
                    debugInfo.innerHTML = debugHtml;
                } else {
                    const errorText = await response.text();
                    console.error('Debug error response:', errorText);
                    debugInfo.innerHTML = `‚ùå Debug Error: ${response.status} - ${errorText}`;
                }
            } catch (error) {
                console.error('Debug mobile state error:', error);
                debugInfo.innerHTML = `‚ùå Debug Error: ${error.message}`;
            }
        }

        function showLogoutOverlay() {
            const overlay = document.getElementById('logout-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.classList.add('active');
            }, 10);
        }

        function hideLogoutOverlay() {
            const overlay = document.getElementById('logout-overlay');
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }


        function confirmLogout() {
            console.log('confirmLogout called');
            
            // Clear all session data
            localStorage.removeItem('currentTransferId');
            localStorage.removeItem('hasSeenLogin');
            console.log('Cleared session data');
            
            // Close any active event streams
            if (eventSource) {
                eventSource.close();
                console.log('Closed event source');
            }
            
            // Hide overlay first
            hideLogoutOverlay();
            
            // Redirect to login page
            console.log('Redirecting to index.html');
            window.location.href = 'index.html';
        }

    </script>
</body>
</html>
